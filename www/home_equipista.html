<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <script src="js/sessionCookie.js" type="text/javascript"></script>
  <script src="js/js_utils.js" type="text/javascript"></script>
  <body>
  	<ul>
	  <li><a class="active" href="seleciona_tela.html">Início</a></li>
	  <li><a href="avisos.html">Avisos</a></li>
	  <li><a href="alterar_senha.html">Alterar Senha</a></li>
	  <li><a onclick="js_sair();">Sair</a></li>
	</ul>
	<h2 class="titulo">PPV</h2>
	<p> Responda o questionário abaixo ou altere a data para visualizar respostas de um dia anterior. </p>
	<label for="dataFiltro">Data: </label>
	<input type="date" id="dataFiltro" onfocus="this.value='';" onchange="if (this.value == '') { this.value = dateToBR(getToday()); getRespostas(); } else { getRespostas(); }"><br>
	<form id="questionario_ejns" onsubmit="return false;">
		<div id="questionario_principal">
			<fieldset>
				<legend>Diário</legend>
				  <p id="q1" class="questao">Como foi sua oração pessoal hoje?</p> <br>
				  <select id="questao_1" name="questao_1">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q2" class="questao">Rezou o TIME OUT hoje?</p> <br>
				  <select id="questao_2" name="questao_2">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q3" class="questao">Como foi sua pratica na escuta e meditação da palavra?</p> <br>
				  <select id="questao_3" name="questao_3">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q4" class="questao">Rezou o terço?</p> <br>
				  <select id="questao_4" name="questao_4">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q5" class="questao">Como foi a participação na missa e nos sacramentos?</p> <br>
				  <select id="questao_5" name="questao_5">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q6" class="questao">Você está cumprindo o ponto de esforço individual?</p> <br>
				  <select id="questao_6" name="questao_6">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q7" class="questao">Você está cumprindo o ponto de esforço em equipe?</p> <br>
				  <select id="questao_7" name="questao_7">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q8" class="questao">Como foi sua descoberta de si mesmo?</p> <br>
				  <select id="questao_8" name="questao_8">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q9" class="questao">Como foi sua vivencia na família?</p> <br>
				  <select id="questao_9" name="questao_9">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>

				  <p id="q10" class="questao">Como foi sua vivencia na igreja e na sociedade?</p> <br>
				  <select id="questao_10" name="questao_10">
				  	<option value="1">Ótimo</option>
				  	<option value="2">Bom</option>
				  	<option value="3">Regular</option>
				  	<option value="4">Fraco</option>
				  </select>					
			</fieldset>
		</div>
		<br>
		<div id="questionario_mensal">
			<fieldset>
				<legend>Mensal</legend>
				<p id="q11" class="questao">Você participou da missa mensal?</p> <br>
					<input type="radio" id="questao_11_1" name="questao_11" value="1" checked>
					<label class="radio-label" for="questao_11_1">Sim</label><br>
	  				<input type="radio" id="questao_11_2" name="questao_11" value="2">
	  				<label class="radio-label" for="questao_11_2">Não</label><br>
				<p id="q12" class="questao">Você participou da reunião formal?</p> <br>
					<input type="radio" id="questao_12_1" name="questao_12" value="1" checked>
					<label class="radio-label" for="questao_12_1">Sim</label><br>
	  				<input type="radio" id="questao_12_2" name="questao_12" value="2">
	  				<label class="radio-label" for="questao_12_2">Não</label><br>
				<p id="q13" class="questao">Você participou do terço em equipe?</p> <br>
					<input type="radio" id="questao_13_1" name="questao_13" value="1" checked>
					<label class="radio-label" for="questao_13_1">Sim</label><br>
	  				<input type="radio" id="questao_13_2" name="questao_13" value="2">
	  				<label class="radio-label" for="questao_13_2">Não</label><br>
				<p id="q14" class="questao">Você participou da reunião informal?</p> <br>
					<input type="radio" id="questao_14_1" name="questao_14" value="1" checked>
					<label class="radio-label" for="questao_14_1">Sim</label><br>
	  				<input type="radio" id="questao_14_2" name="questao_14" value="2">
	  				<label class="radio-label" for="questao_14_2">Não</label><br>
				<p id="q15" class="questao">Você participou dos eventos da EJNS?</p> <br>
					<input type="radio" id="questao_15_1" name="questao_15" value="1" checked>
					<label class="radio-label" for="questao_15_1">Sim</label><br>
	  				<input type="radio" id="questao_15_2" name="questao_15" value="2">
	  				<label class="radio-label" for="questao_15_2">Não</label><br>
				<p id="q16" class="questao">Você fez o estudo do tema?</p> <br>
					<input type="radio" id="questao_16_1" name="questao_16" value="1" checked>
					<label class="radio-label" for="questao_16_1">Sim</label><br>
	  				<input type="radio" id="questao_16_2" name="questao_16" value="2">
	  				<label class="radio-label" for="questao_16_2">Não</label><br>
			</fieldset>
		</div>
	<input id="btn_salvar" type="button" value="Enviar" onClick="salvar();" />
	</form>
  </body>
</html>
<script language="JavaScript">

var isFirefox = typeof InstallTrigger !== 'undefined';

window.onload = function() {
  document.getElementById('dataFiltro').value = dateToBR(getToday());
  
  var dataHoje = getToday().getUTCDate();
  
  if (dataHoje != 25) {
  	//document.getElementById('questionario_mensal').style.visibility = 'hidden';
  	document.getElementById('questionario_mensal').style.display = 'none';
  }
}

function salvar(){

	if (isFirefox) {
		
		var data_form  = dateToEN(document.getElementById('dataFiltro').value);
	} else {
		
		var data_form  = document.getElementById('dataFiltro').value;
	}
  	var aRespostas = new Array();
  	var dataHoje = getToday().getDate()+1;

    for (var i = 1; i <= 10; i++) {

    	var oResposta = new Object();
    	var obj 	  = document.getElementById('questao_'+i);
    	var resposta  = obj.options[obj.selectedIndex].value;

    	oResposta.questao  = i;
    	oResposta.resposta = resposta;

    	aRespostas.push(oResposta);
    }

    if (document.getElementById('questionario_mensal').style.display != 'none') {
    	
    	for (var i = 11; i <= 16; i++) {

	    	var oResposta = new Object();
	    	var objs	  = document.getElementsByName('questao_'+i);
			
			for(var j = 0; j < objs.length; j++){
			    if(objs[j].checked){
			        var resposta = objs[j].value;
			        break;
			    }
			}

	    	oResposta.questao  = i;
	    	oResposta.resposta = resposta;

	    	aRespostas.push(oResposta);
    	}
    }    

    var oParams = new Object();
  	oParams.method = 'salvarQuestionario';
  	oParams.id_usuario = readSession('id_usuario');
  	oParams.data  	   = data_form;
  	oParams.aRespostas = JSON.stringify(aRespostas);

	AJAXRequest("POST", oParams, "completaSalvar");

}

function completaSalvar(oAjax) {
	
	if (oAjax.status == 1) {
		alert("Houve um erro ao salvar as respostas. Tente novamente.");
		return false;
	} else {
		alert("Respostas gravadas com sucesso.");
		ativaDesativaRespostas(true);
		return true;
	}
}

function getRespostas() {
	
	if (isFirefox) {
		
		var data_form  = dateToEN(document.getElementById('dataFiltro').value);
	} else {
		
		var data_form  = document.getElementById('dataFiltro').value;
	}
	var oParams    = new Object();
	oParams.method = 'getQuestionarioPessoaData';
	oParams.id_usuario = readSession('id_usuario');
  	oParams.data  	   = data_form;

  	AJAXRequest("POST", oParams, "completaRespostas");
}

function completaRespostas(oAjax) {

	if (oAjax.status == 1) {

		var data_form = isFirefox ? new Date(dateToEN(document.getElementById('dataFiltro').value)) : new Date(document.getElementById('dataFiltro').value);
		var diaForm = data_form.getUTCDate();
		var diaHoje = getToday().getUTCDate();

		if(diaForm == 25) {

			document.getElementById('questionario_mensal').style.display = 'block';
		} else {

			document.getElementById('questionario_mensal').style.display = 'none';
		}

		if ((data_form.getMonth() != getToday().getMonth()) || (diaHoje - diaForm > 7)) {
    		alert("Você não respondeu o PPV desta data, mas não pode responder depois de uma semana ou no mês seguinte.");
    	    ativaDesativaRespostas(true);
		} else {
    		alert("Você ainda não respondeu o PPV desta data.");
    	    ativaDesativaRespostas(false);
	    }
		return false;
	} else {

		oAjax.respostas.forEach(function(resposta, index){

			var obj = document.getElementsByName('questao_'+resposta.questao)[0];

			if(obj.tagName == 'INPUT') {

				var objChecked = document.getElementById(obj.name+'_'+resposta.resposta);
				objChecked.checked = true;
			} else if (obj.tagName == 'SELECT') {

				obj.value = resposta.resposta;
				
			}
		});
		ativaDesativaRespostas(true);
	}
	return true;
}

//se receber TRUE, DESATIVA todos os elementos de resposta, se for FALSE, ATIVA
function ativaDesativaRespostas(ativado) {
	var inputs  = document.getElementsByTagName('INPUT');
	var aInputs = [].slice.call(inputs);

	aInputs.forEach(function(element, index){
		if(element.type == 'radio' || element.type == 'button') {
			element.disabled = ativado;
		}
	})
	
	var selects = document.getElementsByTagName('SELECT');
	var aSelects = [].slice.call(selects);

	aSelects.forEach(function(element, index){
		element.disabled = ativado;
	})

}
</script>